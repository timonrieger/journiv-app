name: E2E Smoke Test

# Run on every push to main and on all pull requests
# Skip when only documentation or frontend files change
on:
  push:
    branches:
      - main
    paths-ignore:
      - "docs/**"
      - "*.md"
      - "content/**"
      - "web/**"
      - "LICENSE*"
      - "CONTRIBUTING.md"
      - "FUNDING.yml"
  pull_request:
    paths-ignore:
      - "docs/**"
      - "*.md"
      - "content/**"
      - "web/**"
      - "LICENSE*"
      - "CONTRIBUTING.md"
      - "FUNDING.yml"
  workflow_dispatch: # allow manual runs

# Ensure only one workflow runs at a time for each PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke-test:
    name: Health Check (${{ matrix.database }})

    runs-on: ubuntu-latest

    strategy:
      matrix:
        database: [sqlite, postgres]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Journiv Docker image
        run: |
          echo "ðŸ”¨ Building Journiv Docker image..."
          docker build -t swalabtech/journiv-app:latest .

      - name: Create test environment file
        run: |
          echo "ðŸ“ Creating test environment configuration for ${{ matrix.database }}..."
          cat > .env.test <<EOF
          # Test configuration for CI
          SECRET_KEY=test-secret-key-for-ci-only-not-for-production
          DOMAIN_NAME=localhost
          DOMAIN_SCHEME=http
          APP_PORT=8000
          ENVIRONMENT=production
          DEBUG=false
          ENABLE_CORS=false
          DISABLE_SIGNUP=false
          EOF

          # Add database-specific configuration
          if [ "${{ matrix.database }}" = "postgres" ]; then
            cat >> .env.test <<EOF
          POSTGRES_USER=journiv
          POSTGRES_PASSWORD=test-password-ci-only
          POSTGRES_DB=journiv_test
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          EOF
          else
            echo "DATABASE_URL=sqlite:////data/journiv.db" >> .env.test
          fi

          echo "âœ… Environment file created for ${{ matrix.database }}"

      - name: Cleanup previous docker leftovers
        run: |
          echo "ðŸ§¹ Cleaning up any previous Docker containers and volumes..."
          export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
          APP_VERSION=latest docker compose \
            -f docker-compose.prod.${{ matrix.database }}.yml \
            -f docker-compose.override.ci.yml \
            down -v 2>/dev/null || true

          docker volume rm journiv-${{ matrix.database }}_app_data >/dev/null 2>&1 || true
          docker volume rm journiv-${{ matrix.database }}_redis_data >/dev/null 2>&1 || true
          docker volume rm journiv-${{ matrix.database }}_journiv_ci_data >/dev/null 2>&1 || true
          docker volume rm journiv_ci_data >/dev/null 2>&1 || true

          echo "âœ… Cleanup complete"

      - name: Start Journiv with Docker Compose
        run: |
          echo "ðŸš€ Starting Journiv services with APP_VERSION=latest (${{ matrix.database }})..."
          export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
          APP_VERSION=latest docker compose \
            -f docker-compose.prod.${{ matrix.database }}.yml \
            -f docker-compose.override.ci.yml \
            --env-file .env.test up -d

          echo "ðŸ“‹ Checking running containers..."
          export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
          APP_VERSION=latest docker compose \
            -f docker-compose.prod.${{ matrix.database }}.yml \
            -f docker-compose.override.ci.yml \
            ps

      - name: Wait for Journiv to be healthy
        run: |
          echo "â³ Waiting for Journiv backend to become healthy..."
          export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
          MAX_ATTEMPTS=30
          ATTEMPT=0
          SLEEP_TIME=2

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "  Attempt $ATTEMPT/$MAX_ATTEMPTS..."

            # Check if the health endpoint responds with 200
            if curl -f -s http://localhost:8000/api/v1/health > /dev/null 2>&1; then
              echo "âœ… Journiv is healthy!"
              exit 0
            fi

            # Show container status for debugging
            if [ $((ATTEMPT % 5)) -eq 0 ]; then
              echo "  ðŸ“Š Container status:"
              export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
              APP_VERSION=latest docker compose \
                -f docker-compose.prod.${{ matrix.database }}.yml \
                -f docker-compose.override.ci.yml \
                ps
            fi

            sleep $SLEEP_TIME
          done

          echo "âŒ Journiv failed to become healthy after $MAX_ATTEMPTS attempts"
          echo "ðŸ“‹ Final container status:"
          export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
          APP_VERSION=latest docker compose \
            -f docker-compose.prod.${{ matrix.database }}.yml \
            -f docker-compose.override.ci.yml \
            ps
          echo "ðŸ“‹ Application logs:"
          export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
          APP_VERSION=latest docker compose \
            -f docker-compose.prod.${{ matrix.database }}.yml \
            -f docker-compose.override.ci.yml \
            logs app
          exit 1

      - name: Test health endpoint
        run: |
          echo "ðŸ” Testing /api/v1/health endpoint..."

          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8000/api/v1/health)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "  HTTP Status: $HTTP_CODE"
          echo "  Response Body: $BODY"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Health check failed with HTTP $HTTP_CODE"
            exit 1
          fi

          echo "âœ… Health check passed!"

      - name: Show application logs (on success)
        if: success()
        run: |
          echo "ðŸ“‹ Application logs (last 50 lines):"
          export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
          APP_VERSION=latest docker compose \
            -f docker-compose.prod.${{ matrix.database }}.yml \
            -f docker-compose.override.ci.yml \
            logs --tail=50 app

      - name: Show application logs (on failure)
        if: failure()
        run: |
          echo "ðŸ“‹ Full application logs:"
          export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
          APP_VERSION=latest docker compose \
            -f docker-compose.prod.${{ matrix.database }}.yml \
            -f docker-compose.override.ci.yml \
            logs app
          echo ""
          echo "ðŸ“‹ Redis logs:"
          export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
          APP_VERSION=latest docker compose \
            -f docker-compose.prod.${{ matrix.database }}.yml \
            -f docker-compose.override.ci.yml \
            logs redis
          echo ""
          if [ "${{ matrix.database }}" = "postgres" ]; then
            echo "ðŸ“‹ Postgres logs:"
            export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
            APP_VERSION=latest docker compose \
              -f docker-compose.prod.${{ matrix.database }}.yml \
              -f docker-compose.override.ci.yml \
              logs postgres
            echo ""
          fi
          echo "ðŸ“‹ Celery worker logs:"
          export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
          APP_VERSION=latest docker compose \
            -f docker-compose.prod.${{ matrix.database }}.yml \
            -f docker-compose.override.ci.yml \
            logs celery-worker

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          export COMPOSE_PROJECT_NAME=journiv-${{ matrix.database }}
          APP_VERSION=latest docker compose \
            -f docker-compose.prod.${{ matrix.database }}.yml \
            -f docker-compose.override.ci.yml \
            down -v || true

          docker volume rm journiv-${{ matrix.database }}_app_data >/dev/null 2>&1 || true
          docker volume rm journiv-${{ matrix.database }}_redis_data >/dev/null 2>&1 || true
          docker volume rm journiv-${{ matrix.database }}_journiv_ci_data >/dev/null 2>&1 || true
          docker volume rm journiv_ci_data >/dev/null 2>&1 || true

          echo "âœ… Cleanup complete"
